// debug-app.html

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauri 命令调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
        }
        
        .test-title {
            color: #555;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background-color: #0056b3;
        }
        
        .test-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .command-test {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .command-label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }
        
        .command-params {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tauri 命令调试工具</h1>
        
        <!-- 连接状态 -->
        <div id="connection-status" class="info">
            <strong>连接状态:</strong> <span id="status-text">待连接</span>
        </div>
        
        <!-- Tauri API 测试 -->
        <div class="test-section">
            <h2 class="test-title">Tauri API 测试</h2>
            
            <button id="test-api" class="test-button">检查 Tauri API</button>
            <div id="api-result" class="result info"></div>
        </div>
        
        <!-- 命令测试 -->
        <div class="test-section">
            <h2 class="test-title">命令测试</h2>
            
            <!-- 新游戏 -->
            <div class="command-test">
                <span class="command-label">new_game</span>
                <button id="test-new-game" class="test-button">调用 new_game</button>
                <div id="new-game-result" class="result info"></div>
            </div>
            
            <!-- 获取游戏状态 -->
            <div class="command-test">
                <span class="command-label">get_game_state</span>
                <button id="test-get-state" class="test-button">调用 get_game_state</button>
                <div id="get-state-result" class="result info"></div>
            </div>
            
            <!-- 获取有效移动 -->
            <div class="command-test">
                <span class="command-label">get_valid_moves</span>
                <div class="command-params">
                    <label for="move-x">X: </label>
                    <input type="number" id="move-x" min="0" max="8" value="0">
                    <label for="move-y">Y: </label>
                    <input type="number" id="move-y" min="0" max="9" value="0">
                </div>
                <button id="test-get-moves" class="test-button">调用 get_valid_moves</button>
                <div id="get-moves-result" class="result info"></div>
            </div>
            
            <!-- 移动棋子 -->
            <div class="command-test">
                <span class="command-label">make_move</span>
                <div class="command-params">
                    <label for="from-x">From X: </label>
                    <input type="number" id="from-x" min="0" max="8" value="0">
                    <label for="from-y">From Y: </label>
                    <input type="number" id="from-y" min="0" max="9" value="0">
                    <br>
                    <label for="to-x">To X: </label>
                    <input type="number" id="to-x" min="0" max="8" value="1">
                    <label for="to-y">To Y: </label>
                    <input type="number" id="to-y" min="0" max="9" value="1">
                </div>
                <button id="test-make-move" class="test-button">调用 make_move</button>
                <div id="make-move-result" class="result info"></div>
            </div>
            
            <!-- 悔棋 -->
            <div class="command-test">
                <span class="command-label">undo_move</span>
                <button id="test-undo-move" class="test-button">调用 undo_move</button>
                <div id="undo-move-result" class="result info"></div>
            </div>
        </div>
        
        <!-- 性能测试 -->
        <div class="test-section">
            <h2 class="test-title">性能测试</h2>
            <button id="test-performance" class="test-button">运行性能测试</button>
            <div id="performance-result" class="result info"></div>
        </div>
        
        <!-- 应用程序模拟 -->
        <div class="test-section">
            <h2 class="test-title">应用程序模拟</h2>
            <button id="simulate-app" class="test-button">模拟应用程序初始化</button>
            <div id="app-simulation" class="result info"></div>
        </div>
        
        <!-- 错误信息收集 -->
        <div class="test-section">
            <h2 class="test-title">错误信息</h2>
            <div id="errors" class="result error"></div>
        </div>
    </div>
    
    <script type="module">
        // 调试相关代码
        let hasTauri = false;
        let tauri = null;
        
        // DOM 元素
        const statusText = document.getElementById('status-text');
        const connectionStatus = document.getElementById('connection-status');
        const apiResult = document.getElementById('api-result');
        const newGameResult = document.getElementById('new-game-result');
        const getStateResult = document.getElementById('get-state-result');
        const getMovesResult = document.getElementById('get-moves-result');
        const makeMoveResult = document.getElementById('make-move-result');
        const undoMoveResult = document.getElementById('undo-move-result');
        const performanceResult = document.getElementById('performance-result');
        const appSimulation = document.getElementById('app-simulation');
        const errorsDiv = document.getElementById('errors');
        
        // 颜色样式
        function formatText(text, color) {
            return `<span style="color: ${color}">${text}</span>`;
        }
        
        // 记录错误
        function logError(error) {
            const errorText = `[${new Date().toISOString()}] ${error}\n`;
            errorsDiv.textContent += errorText;
            errorsDiv.scrollTop = errorsDiv.scrollHeight;
            console.error(error);
        }
        
        // 更新连接状态
        function updateConnectionStatus(status, isSuccess) {
            statusText.textContent = status;
            connectionStatus.className = isSuccess ? 'success' : 'error';
        }
        
        // 检查 Tauri API
        async function checkTauriAPI() {
            try {
                apiResult.textContent = '正在检查 Tauri API...';
                
                // 尝试导入 Tauri API
                tauri = await import('@tauri-apps/api');
                hasTauri = true;
                
                apiResult.textContent = formatText('✅ Tauri API 导入成功\n', '#28a745');
                apiResult.textContent += formatText(`已加载的模块: ${Object.keys(tauri).join(', ')}\n`, '#007bff');
                apiResult.textContent += formatText(`invoke 函数是否可用: ${typeof tauri.invoke === 'function'}\n`, '#007bff');
                
                updateConnectionStatus('已连接', true);
            } catch (error) {
                hasTauri = false;
                apiResult.textContent = formatText(`❌ 无法加载 Tauri API: ${error.message}`, '#dc3545');
                updateConnectionStatus('未连接', false);
                logError(error);
            }
        }
        
        // 执行命令
        async function executeCommand(command, params = {}) {
            if (!hasTauri) {
                throw new Error('Tauri API 未加载');
            }
            
            const startTime = Date.now();
            try {
                const result = await tauri.invoke(command, params);
                const duration = Date.now() - startTime;
                return { result, duration };
            } catch (error) {
                const duration = Date.now() - startTime;
                throw { error, duration };
            }
        }
        
        // 更新结果显示
        function updateResult(element, data) {
            if (data.result) {
                element.className = 'result success';
                element.textContent = `✅ 成功 (${data.duration}ms):\n${JSON.stringify(data.result, null, 2)}`;
            } else if (data.error) {
                element.className = 'result error';
                element.textContent = `❌ 失败 (${data.duration}ms):\n${JSON.stringify(data.error, null, 2)}`;
            } else {
                element.textContent = '等待执行...';
            }
        }
        
        // 测试新游戏命令
        async function testNewGame() {
            newGameResult.textContent = '正在调用 new_game...';
            try {
                const data = await executeCommand('new_game');
                updateResult(newGameResult, data);
            } catch (data) {
                updateResult(newGameResult, data);
                logError(data.error);
            }
        }
        
        // 测试获取游戏状态命令
        async function testGetGameState() {
            getStateResult.textContent = '正在调用 get_game_state...';
            try {
                const data = await executeCommand('get_game_state');
                updateResult(getStateResult, data);
            } catch (data) {
                updateResult(getStateResult, data);
                logError(data.error);
            }
        }
        
        // 测试获取有效移动命令
        async function testGetValidMoves() {
            const x = parseInt(document.getElementById('move-x').value);
            const y = parseInt(document.getElementById('move-y').value);
            
            getMovesResult.textContent = `正在调用 get_valid_moves(x=${x}, y=${y})...`;
            
            try {
                const data = await executeCommand('get_valid_moves', { x, y });
                updateResult(getMovesResult, data);
            } catch (data) {
                updateResult(getMovesResult, data);
                logError(data.error);
            }
        }
        
        // 测试移动命令
        async function testMakeMove() {
            const fromX = parseInt(document.getElementById('from-x').value);
            const fromY = parseInt(document.getElementById('from-y').value);
            const toX = parseInt(document.getElementById('to-x').value);
            const toY = parseInt(document.getElementById('to-y').value);
            
            makeMoveResult.textContent = `正在调用 make_move(fromX=${fromX}, fromY=${fromY}, toX=${toX}, toY=${toY})...`;
            
            try {
                // 使用下划线格式的参数
                const data = await executeCommand('make_move', { 
                    from_x: fromX, 
                    from_y: fromY, 
                    to_x: toX, 
                    to_y: toY 
                });
                updateResult(makeMoveResult, data);
            } catch (data) {
                updateResult(makeMoveResult, data);
                logError(data.error);
            }
        }
        
        // 测试悔棋命令
        async function testUndoMove() {
            undoMoveResult.textContent = '正在调用 undo_move...';
            try {
                const data = await executeCommand('undo_move');
                updateResult(undoMoveResult, data);
            } catch (data) {
                updateResult(undoMoveResult, data);
                logError(data.error);
            }
        }
        
        // 性能测试
        async function testPerformance() {
            performanceResult.textContent = '正在运行性能测试...';
            
            const commands = [
                { name: 'new_game', params: {} },
                { name: 'get_game_state', params: {} },
                { name: 'get_valid_moves', params: { x: 0, y: 0 } },
            ];
            
            const results = [];
            
            for (const cmd of commands) {
                const times = [];
                
                for (let i = 0; i < 3; i++) {
                    try {
                        const startTime = Date.now();
                        await executeCommand(cmd.name, cmd.params);
                        times.push(Date.now() - startTime);
                    } catch (error) {
                        times.push(null);
                        logError(`命令 ${cmd.name} 执行失败: ${error.message}`);
                    }
                }
                
                results.push({
                    name: cmd.name,
                    params: cmd.params,
                    times,
                    avg: times.filter(t => t !== null).length > 0 
                        ? times.filter(t => t !== null).reduce((a, b) => a + b, 0) / times.filter(t => t !== null).length 
                        : null
                });
            }
            
            let output = '性能测试结果:\n';
            results.forEach(result => {
                output += `\n命令: ${result.name} ${JSON.stringify(result.params)}\n`;
                output += `执行时间: ${result.times.map(t => t !== null ? `${t}ms` : '失败').join(', ')}\n`;
                if (result.avg !== null) {
                    output += `平均时间: ${result.avg.toFixed(2)}ms\n`;
                }
            });
            
            performanceResult.textContent = output;
        }
        
        // 模拟应用程序初始化
        async function simulateApp() {
            appSimulation.textContent = '正在模拟应用程序初始化...';
            
            const steps = [
                '检查 Tauri API',
                '创建游戏管理器',
                '调用 new_game',
                '获取游戏状态',
                '开始游戏循环'
            ];
            
            let output = '';
            
            for (const [index, step] of steps.entries()) {
                output += `${index + 1}. ${step}...\n`;
                appSimulation.textContent = output;
                
                // 模拟延迟
                await new Promise(resolve => setTimeout(resolve, 300));
                
                try {
                    if (step === '检查 Tauri API' && !hasTauri) {
                        await checkTauriAPI();
                    } else if (step === '调用 new_game') {
                        await testNewGame();
                    } else if (step === '获取游戏状态') {
                        await testGetGameState();
                    }
                    
                    output += formatText(`✅ ${step} 成功\n`, '#28a745');
                } catch (error) {
                    output += formatText(`❌ ${step} 失败: ${error.message}\n`, '#dc3545');
                    logError(error);
                }
                
                appSimulation.innerHTML = output;
            }
            
            appSimulation.textContent += '\n模拟完成！';
        }
        
        // 初始化事件监听器
        document.addEventListener('DOMContentLoaded', () => {
            // Tauri API 测试
            document.getElementById('test-api').addEventListener('click', checkTauriAPI);
            
            // 命令测试
            document.getElementById('test-new-game').addEventListener('click', testNewGame);
            document.getElementById('test-get-state').addEventListener('click', testGetGameState);
            document.getElementById('test-get-moves').addEventListener('click', testGetValidMoves);
            document.getElementById('test-make-move').addEventListener('click', testMakeMove);
            document.getElementById('test-undo-move').addEventListener('click', testUndoMove);
            
            // 性能测试
            document.getElementById('test-performance').addEventListener('click', testPerformance);
            
            // 应用程序模拟
            document.getElementById('simulate-app').addEventListener('click', simulateApp);
            
            // 自动检查 Tauri API
            checkTauriAPI();
        });
    </script>
</body>
</html>